/*
 * Hydrus Client API
 *
 * API for interacting with the Hydrus Client
 *
 * The version of the OpenAPI document: 1.0.0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using HydrusAPI.NET.Api;
using HydrusAPI.NET.Model;

namespace HydrusAPI.NET.Client
{
    /// <summary>
    /// Provides hosting configuration for HydrusAPI.NET
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesAddFile200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesAddFileRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesDeleteFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesGenerateHashes200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesGenerateHashesRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddFilesUndeleteFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddNotesDeleteNotesRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddNotesSetNotes200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddNotesSetNotesRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsAddTagsRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsAddTagsRequestServiceKeysToActionsToTagsValueValueInnerJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsCleanTags200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsGetFavouriteTags200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsSearchTags200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsSearchTags200ResponseTagsInnerJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsSetFavouriteTags200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddTagsSetFavouriteTagsRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddUrlsAddUrl200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddUrlsAddUrlRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddUrlsAssociateUrlRequestJsonConverter());
            _jsonOptions.Converters.Add(new AddUrlsGetUrlFiles200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AddUrlsGetUrlFiles200ResponseUrlFileStatusesInnerJsonConverter());
            _jsonOptions.Converters.Add(new ApiVersion200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ArchiveFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new ClearFileDeletionRecordRequestJsonConverter());
            _jsonOptions.Converters.Add(new EditRatingsSetRatingRequestJsonConverter());
            _jsonOptions.Converters.Add(new EditRatingsSetRatingRequestRatingJsonConverter());
            _jsonOptions.Converters.Add(new EditTimesSetFileViewtimeRequestJsonConverter());
            _jsonOptions.Converters.Add(new EditTimesSetTimeRequestJsonConverter());
            _jsonOptions.Converters.Add(new FileMetadataJsonConverter());
            _jsonOptions.Converters.Add(new FileMetadataFileServicesJsonConverter());
            _jsonOptions.Converters.Add(new FileMetadataFileViewingStatisticsInnerJsonConverter());
            _jsonOptions.Converters.Add(new FileRelationshipJsonConverter());
            _jsonOptions.Converters.Add(new FileRelationshipsResponseJsonConverter());
            _jsonOptions.Converters.Add(new FilesJsonConverter());
            _jsonOptions.Converters.Add(new FilesMetadataJsonConverter());
            _jsonOptions.Converters.Add(new GetFilesFileHashes200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetFilesFileMetadata200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetFilesFilePath200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetFilesSearchFiles200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetFilesThumbnailPath200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetLocalFileStorageLocations200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetLocalFileStorageLocations200ResponseLocationsInnerJsonConverter());
            _jsonOptions.Converters.Add(new GetService200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetService200ResponseServiceJsonConverter());
            _jsonOptions.Converters.Add(new GetService400ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetService404ResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetSiblingsAndParentsResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetSiblingsAndParentsResponseTagsValueValueJsonConverter());
            _jsonOptions.Converters.Add(new ImportInfoJsonConverter());
            _jsonOptions.Converters.Add(new IncrementFileViewtimeRequestJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusFilesJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusNetworkJobJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusObjectJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusObjectFilesJsonConverter());
            _jsonOptions.Converters.Add(new JobStatusesResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageCookiesGetCookies200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageCookiesSetCookies200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageCookiesSetCookiesRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageDatabaseMrBones200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageDatabaseMrBones200ResponseBonedStatsJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsGetPotentialPairs200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsGetPotentialsCount200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsGetRandomPotentials200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsSetFileRelationshipsRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsSetFileRelationshipsRequestRelationshipsInnerJsonConverter());
            _jsonOptions.Converters.Add(new ManageFileRelationshipsSetKingsRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersGetHeaders200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersGetHeaders200ResponseHeadersValueJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersGetHeaders200ResponseNetworkContextJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersSetHeaders200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersSetHeadersRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersSetHeadersRequestHeadersValueJsonConverter());
            _jsonOptions.Converters.Add(new ManageHeadersSetUserAgentRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePagesAddFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePagesFocusPageRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePagesRefreshPageRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsAddPopuipRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsCallUserCallableRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsCancelPopupRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsDismissPopupRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsFinishAndDismissPopupRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsFinishPopupRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsUpdatePopuip200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManagePopupsUpdatePopuipRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageServicesCommitPendingRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageServicesForgetPendingRequestJsonConverter());
            _jsonOptions.Converters.Add(new ManageServicesGetPendingCounts200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ManageServicesGetPendingCounts200ResponsePendingCountsValueJsonConverter());
            _jsonOptions.Converters.Add(new MigrateFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new NetworkJobMetadataJsonConverter());
            _jsonOptions.Converters.Add(new PageJsonConverter());
            _jsonOptions.Converters.Add(new PageInfoResponseJsonConverter());
            _jsonOptions.Converters.Add(new PageInfoResponseMediaJsonConverter());
            _jsonOptions.Converters.Add(new PageInfoResponsePageInfoJsonConverter());
            _jsonOptions.Converters.Add(new PageInfoResponsePageInfoManagementJsonConverter());
            _jsonOptions.Converters.Add(new PageInfoResponsePageInfoManagementMultipleWatcherImportJsonConverter());
            _jsonOptions.Converters.Add(new PagesResponseJsonConverter());
            _jsonOptions.Converters.Add(new RequestNewPermissions200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ServiceJsonConverter());
            _jsonOptions.Converters.Add(new SessionKey200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new UnarchiveFilesRequestJsonConverter());
            _jsonOptions.Converters.Add(new UrlInfoJsonConverter());
            _jsonOptions.Converters.Add(new VerifyAccessKey200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new WatcherImportJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);

            _jsonOptions.TypeInfoResolver = System.Text.Json.Serialization.Metadata.JsonTypeInfoResolver.Combine(
                new AddFilesAddFile200ResponseSerializationContext(),
                new AddFilesAddFileRequestSerializationContext(),
                new AddFilesDeleteFilesRequestSerializationContext(),
                new AddFilesGenerateHashes200ResponseSerializationContext(),
                new AddFilesGenerateHashesRequestSerializationContext(),
                new AddFilesUndeleteFilesRequestSerializationContext(),
                new AddNotesDeleteNotesRequestSerializationContext(),
                new AddNotesSetNotes200ResponseSerializationContext(),
                new AddNotesSetNotesRequestSerializationContext(),
                new AddTagsAddTagsRequestSerializationContext(),
                new AddTagsAddTagsRequestServiceKeysToActionsToTagsValueValueInnerSerializationContext(),
                new AddTagsCleanTags200ResponseSerializationContext(),
                new AddTagsGetFavouriteTags200ResponseSerializationContext(),
                new AddTagsSearchTags200ResponseSerializationContext(),
                new AddTagsSearchTags200ResponseTagsInnerSerializationContext(),
                new AddTagsSetFavouriteTags200ResponseSerializationContext(),
                new AddTagsSetFavouriteTagsRequestSerializationContext(),
                new AddUrlsAddUrl200ResponseSerializationContext(),
                new AddUrlsAddUrlRequestSerializationContext(),
                new AddUrlsAssociateUrlRequestSerializationContext(),
                new AddUrlsGetUrlFiles200ResponseSerializationContext(),
                new AddUrlsGetUrlFiles200ResponseUrlFileStatusesInnerSerializationContext(),
                new ApiVersion200ResponseSerializationContext(),
                new ArchiveFilesRequestSerializationContext(),
                new ClearFileDeletionRecordRequestSerializationContext(),
                new EditRatingsSetRatingRequestSerializationContext(),
                new EditRatingsSetRatingRequestRatingSerializationContext(),
                new EditTimesSetFileViewtimeRequestSerializationContext(),
                new EditTimesSetTimeRequestSerializationContext(),
                new FileMetadataSerializationContext(),
                new FileMetadataFileServicesSerializationContext(),
                new FileMetadataFileViewingStatisticsInnerSerializationContext(),
                new FileRelationshipSerializationContext(),
                new FileRelationshipsResponseSerializationContext(),
                new FilesSerializationContext(),
                new FilesMetadataSerializationContext(),
                new GetFilesFileHashes200ResponseSerializationContext(),
                new GetFilesFileMetadata200ResponseSerializationContext(),
                new GetFilesFilePath200ResponseSerializationContext(),
                new GetFilesSearchFiles200ResponseSerializationContext(),
                new GetFilesThumbnailPath200ResponseSerializationContext(),
                new GetLocalFileStorageLocations200ResponseSerializationContext(),
                new GetLocalFileStorageLocations200ResponseLocationsInnerSerializationContext(),
                new GetService200ResponseSerializationContext(),
                new GetService200ResponseServiceSerializationContext(),
                new GetService400ResponseSerializationContext(),
                new GetService404ResponseSerializationContext(),
                new GetSiblingsAndParentsResponseSerializationContext(),
                new GetSiblingsAndParentsResponseTagsValueValueSerializationContext(),
                new ImportInfoSerializationContext(),
                new IncrementFileViewtimeRequestSerializationContext(),
                new JobStatusSerializationContext(),
                new JobStatusFilesSerializationContext(),
                new JobStatusNetworkJobSerializationContext(),
                new JobStatusObjectSerializationContext(),
                new JobStatusObjectFilesSerializationContext(),
                new JobStatusesResponseSerializationContext(),
                new ManageCookiesGetCookies200ResponseSerializationContext(),
                new ManageCookiesSetCookies200ResponseSerializationContext(),
                new ManageCookiesSetCookiesRequestSerializationContext(),
                new ManageDatabaseMrBones200ResponseSerializationContext(),
                new ManageDatabaseMrBones200ResponseBonedStatsSerializationContext(),
                new ManageFileRelationshipsGetPotentialPairs200ResponseSerializationContext(),
                new ManageFileRelationshipsGetPotentialsCount200ResponseSerializationContext(),
                new ManageFileRelationshipsGetRandomPotentials200ResponseSerializationContext(),
                new ManageFileRelationshipsSetFileRelationshipsRequestSerializationContext(),
                new ManageFileRelationshipsSetFileRelationshipsRequestRelationshipsInnerSerializationContext(),
                new ManageFileRelationshipsSetKingsRequestSerializationContext(),
                new ManageHeadersGetHeaders200ResponseSerializationContext(),
                new ManageHeadersGetHeaders200ResponseHeadersValueSerializationContext(),
                new ManageHeadersGetHeaders200ResponseNetworkContextSerializationContext(),
                new ManageHeadersSetHeaders200ResponseSerializationContext(),
                new ManageHeadersSetHeadersRequestSerializationContext(),
                new ManageHeadersSetHeadersRequestHeadersValueSerializationContext(),
                new ManageHeadersSetUserAgentRequestSerializationContext(),
                new ManagePagesAddFilesRequestSerializationContext(),
                new ManagePagesFocusPageRequestSerializationContext(),
                new ManagePagesRefreshPageRequestSerializationContext(),
                new ManagePopupsAddPopuipRequestSerializationContext(),
                new ManagePopupsCallUserCallableRequestSerializationContext(),
                new ManagePopupsCancelPopupRequestSerializationContext(),
                new ManagePopupsDismissPopupRequestSerializationContext(),
                new ManagePopupsFinishAndDismissPopupRequestSerializationContext(),
                new ManagePopupsFinishPopupRequestSerializationContext(),
                new ManagePopupsUpdatePopuip200ResponseSerializationContext(),
                new ManagePopupsUpdatePopuipRequestSerializationContext(),
                new ManageServicesCommitPendingRequestSerializationContext(),
                new ManageServicesForgetPendingRequestSerializationContext(),
                new ManageServicesGetPendingCounts200ResponseSerializationContext(),
                new ManageServicesGetPendingCounts200ResponsePendingCountsValueSerializationContext(),
                new MigrateFilesRequestSerializationContext(),
                new NetworkJobMetadataSerializationContext(),
                new PageSerializationContext(),
                new PageInfoResponseSerializationContext(),
                new PageInfoResponseMediaSerializationContext(),
                new PageInfoResponsePageInfoSerializationContext(),
                new PageInfoResponsePageInfoManagementSerializationContext(),
                new PageInfoResponsePageInfoManagementMultipleWatcherImportSerializationContext(),
                new PagesResponseSerializationContext(),
                new RequestNewPermissions200ResponseSerializationContext(),
                new ServiceSerializationContext(),
                new SessionKey200ResponseSerializationContext(),
                new UnarchiveFilesRequestSerializationContext(),
                new UrlInfoSerializationContext(),
                new VerifyAccessKey200ResponseSerializationContext(),
                new WatcherImportSerializationContext(),
                new System.Text.Json.Serialization.Metadata.DefaultJsonTypeInfoResolver()
            );

            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<AccessManagementApiEvents>();
            _services.AddSingleton<AddFilesApiEvents>();
            _services.AddSingleton<AddNotesApiEvents>();
            _services.AddSingleton<AddTagsApiEvents>();
            _services.AddSingleton<AddUrlsApiEvents>();
            _services.AddSingleton<EditRatingsApiEvents>();
            _services.AddSingleton<EditTimesApiEvents>();
            _services.AddSingleton<GetFilesApiEvents>();
            _services.AddSingleton<ManageCookiesApiEvents>();
            _services.AddSingleton<ManageDatabaseApiEvents>();
            _services.AddSingleton<ManageFileRelationshipsApiEvents>();
            _services.AddSingleton<ManageHeadersApiEvents>();
            _services.AddSingleton<ManagePagesApiEvents>();
            _services.AddSingleton<ManagePopupsApiEvents>();
            _services.AddSingleton<ManageServicesApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddHydrusApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IAccessManagementApi, AccessManagementApi>(client));
            builders.Add(_services.AddHttpClient<IAddFilesApi, AddFilesApi>(client));
            builders.Add(_services.AddHttpClient<IAddNotesApi, AddNotesApi>(client));
            builders.Add(_services.AddHttpClient<IAddTagsApi, AddTagsApi>(client));
            builders.Add(_services.AddHttpClient<IAddUrlsApi, AddUrlsApi>(client));
            builders.Add(_services.AddHttpClient<IEditRatingsApi, EditRatingsApi>(client));
            builders.Add(_services.AddHttpClient<IEditTimesApi, EditTimesApi>(client));
            builders.Add(_services.AddHttpClient<IGetFilesApi, GetFilesApi>(client));
            builders.Add(_services.AddHttpClient<IManageCookiesApi, ManageCookiesApi>(client));
            builders.Add(_services.AddHttpClient<IManageDatabaseApi, ManageDatabaseApi>(client));
            builders.Add(_services.AddHttpClient<IManageFileRelationshipsApi, ManageFileRelationshipsApi>(client));
            builders.Add(_services.AddHttpClient<IManageHeadersApi, ManageHeadersApi>(client));
            builders.Add(_services.AddHttpClient<IManagePagesApi, ManagePagesApi>(client));
            builders.Add(_services.AddHttpClient<IManagePopupsApi, ManagePopupsApi>(client));
            builders.Add(_services.AddHttpClient<IManageServicesApi, ManageServicesApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
