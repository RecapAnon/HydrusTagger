# Hydrus Tagger

A tool for automatically tagging media files in a Hydrus database using AI models. This application integrates with the Hydrus API to fetch files and apply tags generated by various AI models including DeepDanbooru, Waifu Diffusion, and custom captioning services.

## Features

- **Multi-model Tagging**: Combines tags from DeepDanbooru, Waifu Diffusion, and custom AI captioning services
- **Hydrus Integration**: Direct integration with Hydrus through its API for seamless tagging
- **Video Support**: Extracts frames from videos for tagging
- **Configurable Services**: Supports multiple AI services with customizable prompts and settings
- **Error Handling**: Robust error handling and logging for reliable operation

## Prerequisites

- [.NET 6.0 SDK](https://dotnet.microsoft.com/download) or later
- Hydrus client with API access enabled
- AI model files (DeepDanbooru and Waifu Diffusion models)

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/hydrus-tagger.git
cd hydrus-tagger
```

2. Restore NuGet packages:
```bash
dotnet restore
```

3. Build the project:
```bash
dotnet build
```

## Configuration

Create an `appsettings.json` file in the project root with the following structure:

```json
{
  "BaseUrl": "http://localhost:45869",
  "HydrusClientAPIAccessKey": "your-api-key",
  "ServiceKey": "your-service-key",
  "ResnetModelPath": "path/to/deepdanbooru/model.onnx",
  "ResnetLabelPath": "path/to/deepdanbooru/labels.txt",
  "WaifuModelPath": "path/to/waifu/model.onnx",
  "WaifuLabelPath": "path/to/waifu/labels.txt",
  "Services": [
    {
      "Name": "caption-service",
      "Endpoint": "https://api.openai.com/v1",
      "Key": "your-openai-key",
      "Model": "gpt-4-vision-preview",
      "SystemPrompt": "You are an AI that generates descriptive tags for images.",
      "UserPrompt": "Generate tags for this image."
    }
  ],
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

## Usage

Run the application with tags to search for in Hydrus:

```bash
dotnet run -- "tag1" "tag2"
```

The application will:
1. Search for files with the specified tags in Hydrus
2. Retrieve each file and extract a frame if it's a video
3. Generate tags using DeepDanbooru, Waifu Diffusion, and configured AI services
4. Apply the combined tags to the file in Hydrus

## Configuration Options

| Option | Description | Required |
|--------|-------------|----------|
| `BaseUrl` | Base URL of the Hydrus instance | Yes |
| `HydrusClientAPIAccessKey` | API key for Hydrus access | Yes |
| `ServiceKey` | Hydrus service key where tags should be applied | No |
| `ResnetModelPath` | Path to DeepDanbooru ONNX model file | No |
| `ResnetLabelPath` | Path to DeepDanbooru labels file | No |
| `WaifuModelPath` | Path to Waifu Diffusion ONNX model file | No |
| `WaifuLabelPath` | Path to Waifu Diffusion labels file | No |
| `Services` | Array of AI services for captioning | No |

## License

MIT License

## Contributing

Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.
